const backpackSkins = [
    "alphabet (G, R, A, N and D)",
    "alphabet (G)",
    "alphabet (R)",
    "alphabet (A)",
    "alphabet (N)",
    "alphabet (D)",
    "animal juice",
    "animal skin",
    "arena container",
    "attack juice",
    "10% attack juice",
    "20% attack juice",
    "25% attack juice",
    "automatic drill",
    "automatic oil well",
    "automatic rod",
    "automatic sawmill",
    "automatic watering can",
    "power armored vest skin",
    "power armored vest skin (V.1)",
    "power armored vest skin (V.2)",
    "power armored vest skin (V.3)",
    "alcohlic beverage cheetah",
    "battery",
    "batteries",
    "Benefactor container",
    "big fireworks",
    "binoculars",
    "body armour skin",
    "high quality brakes",
    "medium quality brakes",
    "low quality brakes",
    "baltic beer",
    "blazzzer alcohlic beverage",
    "burglarized house container",
    "backpack space (low, medium, high & max quality)",
    "max quality backpack space",
    "high quality backpack space",
    "medium quality backpack space",
    "low quality backpack space",
    "small Birthday gift",
    "big Birthday gift",
    "tokens",
    "cabbage",
    "cabbage seeds",
    "campfire",
    "caravan container",
    "carp",
    "Cayo Perico tickets",
    "chair",
    "chair 1",
    "chair 2",
    "chair 3",
    "chair 4",
    "chair 5",
    "chair 6",
    "Christmas lollipop",
    "Christmas tree of type 1",
    "Christmas tree of type 2",
    "Christmas tree of type 3",
    "Christmas tree of type 4",
    "Christmas tree of type 5",
    "cigarettes",
    "coblevo wine",
    "container for bikers 1",
    "container for bikers 2",
    "container for bikers 3",
    "container for bikers 4",
    "container for bikers 5",
    "container for branded shorts",
    "container for branded t-shirts",
    "container for drifters 1",
    "container for drifters 2",
    "container for drifters 3",
    "container for men 1",
    "container for men 2",
    "container for racers 1",
    "container for racers 2",
    "container for racers 3",
    "container for women 1",
    "container for women 2",
    "container with wheels 1",
    "container with wheels 2",
    "container with wheels 3",
    "copper",
    "daily container",
    "desert scarf mask container",
    "diamond",
    "dice",
    "double paycheck juice",
    "drawing print",
    "prints",
    "elixir",
    "electric chargers",
    "emerald",
    "endurance juice",
    "high quality engine",
    "medium quality engine",
    "low quality engine",
    "exclusive truckers container",
    "explosive fireworks",
    "earplugs",
    "fast running juice",
    "fish",
    "high quality fishing rod",
    "medium quality fishing rod",
    "low quality fishing rod",
    "flag",
    "flowers",
    "fruit",
    "fuel canister",
    "fuel for resource extraction",
    "red fabric",
    "blue fabric",
    "yellow fabric",
    "green fabric",
    "purple fabric",
    "gardeners container",
    "gasoline barrels",
    "grand ticket",
    "a grand ticket",
    "GrandPro bodycam",
    "grill",
    "hookah",
    "high quality metal",
    "immunity juice",
    "ingrand container",
    "10% juice",
    "20% juice",
    "25% juice",
    "kerosene barrels",
    "leash",
    "license plate",
    "lottery tickets",
    "love container",
    "luminous stone",
    "mandarin seeds",
    "mandarins",
    "map of Los Santos",
    "milk",
    "mining resources",
    "multivitamin juice",
    "mushroom seeds",
    "mushrooms",
    "Monowheel",
    "neon armored vest skin",
    "neon armored vest skin (V.1)",
    "neon armored vest skin (V.2)",
    "neon armored vest skin (V.3)",
    "neon Muci armored vest skin",
    "neon Muci armored vest skin (V.1)",
    "neon Muci armored vest skin (V.2)",
    "neon Muci armored vest skin (V.3)",
    "neon Lui Vi armored vest skin",
    "neon Lui Vi armored vest skin (V.1)",
    "neon Lui Vi armored vest skin (V.2)",
    "neon Lui Vi armored vest skin (V.3)",
    "neon armored vest skin with chains",
    "neon armored vest skin with chains (V.1)",
    "neon armored vest skin with chains (V.2)",
    "neon armored vest skin with chains (V.3)",
    "neon Summer 2023 armored vest skin",
    "neon Summer 2023 armored vest skin (V.1)",
    "neon Summer 2023 armored vest skin (V.2)",
    "neon Summer 2023 armored vest skin (V.3)",
    "new year gift",
    "Ocelot container",
    "oil barrel",
    "organisation container",
    "old autumn gold container",
    "old winter gold container",
    "old summer gold container",
    "paint cans",
    "pearl",
    "perch",
    "pet",
    "pet border collie",
    "pet cat",
    "pet chicken",
    "pet Christmas elf",
    "pet dog",
    "pet duck",
    "pet food",
    "pet ghost",
    "pet golden retriever",
    "pet huggy wuggy",
    "pet husky",
    "pet kitty bunny",
    "pet monkey",
    "pet panda",
    "pet panther",
    "pet pig",
    "pet poodle",
    "pet pug",
    "pet puma",
    "pet pumpkin guardian",
    "pet rabbit",
    "pet rat",
    "pet rooster",
    "pet rottweiler",
    "pet Santa Claus",
    "pet voodoo doll",
    "pet westie",
    "pet X-mas husky",
    "pickaxe (low, medium & high quality)",
    "high quality pickaxe",
    "medium quality pickaxe",
    "low quality pickaxe",
    "pineapple seeds",
    "pineapples",
    "platinum prime ticket of type 7",
    "platinum prime ticket of type 10",
    "platinum prime ticket of type 15",
    "platinum prime ticket of type 20",
    "platinum prime ticket of type 21",
    "platinum prime ticket of type 30",
    "pool table",
    "port wine 666",
    "power booster",
    "power juice",
    "10% power juice",
    "20% power juice",
    "25% power juice",
    "premium fuel canister",
    "starter prime ticket of type 7",
    "starter prime ticket of type 10",
    "starter prime ticket of type 15",
    "starter prime ticket of type 20",
    "starter prime ticket of type 30",
    "Progen container",
    "protection juice",
    "10% protection juice",
    "20% protection juice",
    "25% protection juice",
    "pumpkin seeds",
    "pumpkins",
    "purifield water",
    "pet treat",
    "pet Fancy Bear",
    "repair kit",
    "resource scanner",
    "riding juice",
    "ruby/rubies",
    "resources container",
    "rare lottery tickets",
    "salmon",
    "sand",
    "sand figures",
    "scarecrow flag",
    "scrap metal",
    "shovel",
    "sim-cards",
    "Single fireworks",
    "snow",
    "snow figure of type 1/2/3",
    "snowballs",
    "solar barrel",
    "solar panel",
    "sphere of influence container",
    "prime ticket of type 3",
    "prime ticket of type 5",
    "prime ticket of type 7",
    "prime ticket of type 10",
    "prime ticket of type 15",
    "prime ticket of type 20",
    "prime ticket of type 30",
    "strawberries",
    "study of the organisation container",
    "Summer 2023 armoured vest skin",
    "Summer 2023 armoured vest skin (V.1)",
    "Summer 2023 armoured vest skin (V.2)",
    "Summer 2023 armoured vest skin (V.3)",
    "high quality suspension",
    "medium quality suspension",
    "low quality suspension",
    "school container",
    "snow figure of type 1",
    "snow figure of type 2",
    "snow figure of type 3",
    "tactical grand armored vest skin",
    "tent",
    "threads",
    "timber",
    "tincture of the forest mushrooms",
    "tokens",
    "high quality transmission",
    "medium quality transmission",
    "low quality transmission",
    "Trezor container",
    "trout",
    "high quality tyres",
    "medium quality tyres",
    "low quality tyres",
    "tuning parts",
    "treasure map",
    "unique love container",
    "unique rims of type 1",
    "unique rims of type 2",
    "unique rims of type 3",
    "unique rims of type 4",
    "unique rims of type 5",
    "unique rims of type 6",
    "unique rims of type 7",
    "unique rims of type 8",
    "unique rims of type 9",
    "unique rims of type 10",
    "unique rims of type 11",
    "unique rims of type 12",
    "unique rims of type 13",
    "unique rims of type 14",
    "unique rims of type 15",
    "unique rims of type 16",
    "unique rims of type 17",
    "unique rims of type 18",
    "unique rims of type 19",
    "unique rims of type 20",
    "unique rims of type 21",
    "unique rims of type 22",
    "unique rims of type 23",
    "unique rims of type 24",
    "unique rims of type 25",
    "unique rims of type 26",
    "unique rims of type 27",
    "unique rims of type 28",
    "unique rims of type 29",
    "unique rims of type 30",
    "unique rims of type 31",
    "unique rims of type 32",
    "unique rims of type 33",
    "unique rims of type 34",
    "unique rims of type 35",
    "unique rims of type 36",
    "unique rims of type 37",
    "unique rims of type 38",
    "unique rims of type 39",
    "unique rims of type 40",
    "valuable container",
    "video card",
    "volcano fireworks",
    "vodka-shotka",
    "ValentineÂ gift",
	"wire",
];

class TransactionForm {
    constructor() {
        this.state = {
            type: 'selling',
            isTrading: false,
            items: ['', '', ''],
            prices: ['', '', ''],
            usePluralS: [false, false, false],
            useRespectively: false,
            activeItemCount: 1,
            useEach: [false, false, false],
            useInBulk: false
        };

        this.initializeElements();
        this.attachEventListeners();
        this.updateUI(); // Initial UI update
        this.updatePreview(); // Initial preview update
    }

    initializeElements() {
        this.form = document.getElementById('transactionForm');
        this.itemsContainer = document.getElementById('itemsContainer');
        this.pricesContainer = document.getElementById('pricesContainer');
        this.preview = document.getElementById('preview');
        this.itemCount = document.getElementById('itemCount');
        this.itemsTitle = document.getElementById('itemsTitle');
        this.respectivelyCheck = document.querySelector('.respectively-check');
        this.itemControls = document.querySelector('.item-controls');
        this.inBulkInput = document.getElementById('inBulkOption'); // Updated ID
        this.inBulkLabel = document.querySelector('label[for="inBulkOption"]'); // Get the label
        this.tradingOptionInput = document.getElementById('tradingOption'); // Get Trading Option input
        this.tradingOptionLabel = document.querySelector('label[for="tradingOption"]'); // Get Trading Option label
    }

    attachEventListeners() {
        // Transaction Type Radio Buttons are handled by the inline script now.
        // Their 'change' events on the hidden inputs will be listened to update state
        document.querySelectorAll('input[name="transactionType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.state.type = e.target.value;
                this.updatePreview();
            });
        });

        // Trading Option Input change listener (kept from previous versions)
        if (this.tradingOptionInput) {
            this.tradingOptionInput.addEventListener('change', (e) => {
                this.state.isTrading = e.target.checked;
                this.state.activeItemCount = e.target.checked ? 2 : 1; // Set item count to 2 for trading
                this.updateUI(); // Update UI based on trading state
                this.updatePreview(); // Update preview
            });
             // Initialize the active state of the Trading Option label on page load
            if (this.tradingOptionInput.checked && this.tradingOptionLabel) {
                 this.tradingOptionLabel.classList.add('active');
             }
        }


        document.getElementById('respectively').addEventListener('change', (e) => {
            this.state.useRespectively = e.target.checked;
            this.updatePreview();
        });

        document.getElementById('addItem').addEventListener('click', () => this.handleAddItem());
        document.getElementById('removeItem').addEventListener('click', () => this.handleRemoveItem());

        document.getElementById('copyButton').addEventListener('click', () => this.handleCopy());

        // Event listener for the "In Bulk" checkbox button (handled by inline script now)
        if (this.inBulkInput && this.inBulkLabel) {
             this.inBulkInput.addEventListener('change', (e) => {
                 this.state.useInBulk = e.target.checked;
                 this.updatePreview();
                 // The inline script handles adding/removing the 'active' class on the label
             });
             // Initialize the active state of the In Bulk label on page load
             if (this.inBulkInput.checked) {
                 this.inBulkLabel.classList.add('active');
             }
         }
    }

    handleAddItem() {
        if (this.state.activeItemCount < 3 && !this.state.isTrading) { // Only add if not trading
            this.state.activeItemCount++;
             // Initialize state for the new item and price
            this.state.items[this.state.activeItemCount - 1] = '';
            this.state.prices[this.state.activeItemCount - 1] = '';
            this.state.usePluralS[this.state.activeItemCount - 1] = false;
            this.state.useEach[this.state.activeItemCount - 1] = false;

            this.updateUI();
            this.updatePreview();
        }
    }

    handleRemoveItem() {
        if (this.state.activeItemCount > 1 && !this.state.isTrading) { // Only remove if not trading
            // Clear state for the item being removed
            this.state.items[this.state.activeItemCount - 1] = '';
            this.state.prices[this.state.activeItemCount - 1] = '';
            this.state.usePluralS[this.state.activeItemCount - 1] = false;
            this.state.useEach[this.state.activeItemCount - 1] = false;

            this.state.activeItemCount--;
            this.updateUI();
            this.updatePreview();
        }
    }

     handleCopy() {
        const button = document.getElementById('copyButton');
        const originalContent = button.innerHTML;

        // Create a temporary textarea element to hold the text
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = this.preview.textContent;
        document.body.appendChild(tempTextArea);

        // Select the text in the textarea
        tempTextArea.select();
        tempTextArea.setSelectionRange(0, 99999); // For mobile devices

        // Copy the text to the clipboard
        navigator.clipboard.writeText(tempTextArea.value).then(() => {
             // Show notification (assuming you add the notification element and CSS)
             const notification = document.getElementById('notification');
             if (notification) {
                 notification.classList.add('show');
                 setTimeout(() => {
                     notification.classList.remove('show');
                 }, 2000); // Hide after 2 seconds
             }

             // Change button text and icon
             button.innerHTML = `
                 <i class="fas fa-check"></i> <span class="d-none d-sm-inline">Copied!</span>
             `;

             // Restore original button content after a delay
             setTimeout(() => {
                 button.innerHTML = originalContent;
             }, 2000); // Match notification display time

         }).catch(err => {
             console.error('Failed to copy:', err);
             // Optionally, provide feedback to the user that copying failed
         }).finally(() => {
             // Clean up the temporary textarea
             document.body.removeChild(tempTextArea);
         });
    }


    createInputGroup(type, index) {
        const div = document.createElement('div');
        div.className = `${type}-input-group mb-3`;

        if (type === 'item') {
            const row = document.createElement('div');
            row.className = 'row g-2';

            const itemCol = document.createElement('div');
            itemCol.className = 'col';

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group'; // This needs position: relative for suggestions absolute positioning

            const span = document.createElement('span');
            span.className = 'input-group-text';
            span.innerHTML = '<i class="fas fa-box"></i>'; // Using Font Awesome icon

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control item-input';
            input.placeholder = this.state.isTrading
                ? (index === 0 ? 'Your item' : 'Wanted item')
                : `Item ${index + 1}`;

            // Extract item name without quantity for setting value and suggestions
            const initialItemValue = this.state.items[index]?.split(' x ')[0] || '';
            input.value = initialItemValue;


            input.addEventListener('input', (e) => {
                const quantity = this.state.items[index]?.split(' x ')[1] || '';
                this.state.items[index] = quantity ? `${e.target.value.trim()} x ${quantity.trim()}` : e.target.value.trim();
                this.handleItemInput(e.target, index);
                this.updatePreview();
            });

             // Add event listener for focus to show suggestions
             input.addEventListener('focus', (e) => {
                 // Trigger input event on focus to show suggestions if text is already there
                 if (e.target.value) {
                     this.handleItemInput(e.target, index);
                 }
             });

             // Add event listener for blur to hide suggestions (with a slight delay)
             input.addEventListener('blur', () => {
                 setTimeout(() => {
                     const suggestionsDiv = inputGroup.querySelector('.suggestions'); // Select relative to inputGroup
                     if (suggestionsDiv) {
                         suggestionsDiv.classList.add('d-none');
                     }
                 }, 100); // Small delay to allow click on suggestion item
             });


            inputGroup.appendChild(span);
            inputGroup.appendChild(input);

            const suggestions = document.createElement('div');
            // Ensure suggestions div has correct classes for styling and hiding
            suggestions.className = 'suggestions d-none position-absolute w-100 bg-white border rounded-bottom shadow-sm';
            inputGroup.appendChild(suggestions); // Append suggestions *inside* the input group

            itemCol.appendChild(inputGroup);

            const quantityCol = document.createElement('div');
            quantityCol.className = 'col-3';

            const quantityInput = document.createElement('input');
            quantityInput.type = 'text';
            quantityInput.className = 'form-control quantity-input'; // Add a class for easier selection
            quantityInput.placeholder = 'Qty'; // Shorter placeholder
            // Extract quantity for setting initial value
            const initialQuantityValue = this.state.items[index]?.split(' x ')[1] || '';
            quantityInput.value = initialQuantityValue;


            quantityInput.addEventListener('input', (e) => {
                const itemName = this.state.items[index]?.split(' x ')[0] || '';
                this.state.items[index] = e.target.value.trim() ? `${itemName.trim()} x ${e.target.value.trim()}` : itemName.trim();
                this.updatePreview();
            });

            quantityCol.appendChild(quantityInput);

            const pluralCol = document.createElement('div');
            pluralCol.className = 'col-auto d-flex align-items-center'; // Use col-auto to fit content

            const pluralCheckLabel = document.createElement('label'); // Style this label as a button
            pluralCheckLabel.className = 'checkbox-button-label';
            pluralCheckLabel.htmlFor = `usePluralS${index}`;

            const pluralInput = document.createElement('input');
            pluralInput.type = 'checkbox';
            pluralInput.id = `usePluralS${index}`;
            pluralInput.className = 'd-none'; // Hide the default checkbox
            pluralInput.checked = this.state.usePluralS[index];

            const pluralTextSpan = document.createElement('span');
            pluralTextSpan.textContent = 'Add "S"';

            pluralCheckLabel.appendChild(pluralInput);
            // The tick icon is handled by the CSS pseudo-element
            pluralCheckLabel.appendChild(pluralTextSpan);


            pluralInput.addEventListener('change', (e) => {
                this.state.usePluralS[index] = e.target.checked;
                 // Get the parent label element and toggle the active class
                 const label = e.target.parentElement;
                 if (label) {
                     if (e.target.checked) {
                         label.classList.add('active');
                     } else {
                         label.classList.remove('active');
                     }
                 }
                this.updatePreview(); // Update preview when "Add S" state changes
            });

             // Initialize the active state of the plural label
            if (this.state.usePluralS[index]) {
                pluralCheckLabel.classList.add('active');
            }

             // Add click listener to the label to toggle the hidden input (for consistency with other checkbox buttons)
            pluralCheckLabel.addEventListener('click', (e) => {
                 e.preventDefault(); // Prevent default label click
                 pluralInput.checked = !pluralInput.checked;
                 pluralInput.dispatchEvent(new Event('change')); // Trigger change event
            });


            pluralCol.appendChild(pluralCheckLabel);

            row.appendChild(itemCol);
            row.appendChild(quantityCol);
            // Only add plural column if not trading
            if (!this.state.isTrading) {
                 row.appendChild(pluralCol);
            }
            div.appendChild(row);

        } else { // Type is 'price'
            const row = document.createElement('div');
            row.className = 'row g-2';

            const priceCol = document.createElement('div');
            priceCol.className = 'col';

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';

            const span = document.createElement('span');
            span.className = 'input-group-text';
            span.innerHTML = '<i class="fas fa-dollar-sign"></i>'; // Using Font Awesome icon

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control price-input'; // Add a class for potential price input specific styling
            input.placeholder = this.state.isTrading ? `Price/Budget for item ${index + 1}` : `Price for item ${index + 1}`; // Adjust placeholder for trading
            input.value = this.state.prices[index];


            input.addEventListener('input', (e) => {
                this.state.prices[index] = e.target.value.trim(); // Trim price input
                this.updatePreview();
            });

            inputGroup.appendChild(span);
            inputGroup.appendChild(input);
            priceCol.appendChild(inputGroup);

            const eachCol = document.createElement('div');
            eachCol.className = 'col-auto d-flex align-items-center';

            const eachCheckLabel = document.createElement('label'); // Style this label as a button
            eachCheckLabel.className = 'checkbox-button-label';
            eachCheckLabel.htmlFor = `useEach${index}`;

            const eachInput = document.createElement('input');
            eachInput.type = 'checkbox';
            eachInput.id = `useEach${index}`;
            eachInput.className = 'd-none'; // Hide the default checkbox
            eachInput.checked = this.state.useEach[index];

            const eachTextSpan = document.createElement('span');
            eachTextSpan.textContent = 'Each';

            eachCheckLabel.appendChild(eachInput);
             // The tick icon is handled by the CSS pseudo-element
            eachCheckLabel.appendChild(eachTextSpan);

            eachInput.addEventListener('change', (e) => {
                this.state.useEach[index] = e.target.checked;
                 // Get the parent label element and toggle the active class
                const label = e.target.parentElement;
                 if (label) {
                     if (e.target.checked) {
                         label.classList.add('active');
                     } else {
                         label.classList.remove('active');
                     }
                 }
                this.updatePreview(); // Update preview when "Each" state changes
            });

             // Initialize the active state of the each label
             if (this.state.useEach[index]) {
                 eachCheckLabel.classList.add('active');
             }

             // Add click listener to the label to toggle the hidden input (for consistency with other checkbox buttons)
             eachCheckLabel.addEventListener('click', (e) => {
                 e.preventDefault(); // Prevent default label click
                 eachInput.checked = !eachInput.checked;
                 eachInput.dispatchEvent(new Event('change')); // Trigger change event
             });


            eachCol.appendChild(eachCheckLabel);

            row.appendChild(priceCol);
            // Only add 'Each' column if not trading
            if (!this.state.isTrading) {
                 row.appendChild(eachCol);
            }
            div.appendChild(row);
        }

        return div;
    }

    handleItemInput(input, index) {
        // Select suggestions div relative to the parent input group
        const suggestionsDiv = input.parentElement.querySelector('.suggestions');
        const value = input.value.toLowerCase();

        // Clear previous suggestions if input is empty
        if (!value) {
            if (suggestionsDiv) {
                 suggestionsDiv.innerHTML = '';
                 suggestionsDiv.classList.add('d-none');
             }
             return; // Exit if no input value
        }


        if (suggestionsDiv) { // Check if suggestionsDiv was found
            const filtered = backpackSkins.filter(skin =>
                skin.toLowerCase().includes(value)
            );

            if (filtered.length > 0) {
                suggestionsDiv.innerHTML = filtered.map(suggestion => `
                    <div class="suggestion-item">${suggestion}</div>
                `).join('');

                suggestionsDiv.classList.remove('d-none');

                suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                    // Use a mousedown listener instead of click for suggestions
                    // This fires before the blur event on the input, allowing the click to register
                    item.addEventListener('mousedown', (e) => {
                         e.preventDefault(); // Prevent input blur from hiding suggestions immediately
                         const selectedValue = item.textContent;
                         const quantity = this.state.items[index]?.split(' x ')[1] || '';
                         this.state.items[index] = quantity ? `${selectedValue.trim()} x ${quantity.trim()}` : selectedValue.trim(); // Trim selected value
                         input.value = selectedValue; // Set input value to selected suggestion
                         if (suggestionsDiv) {
                            suggestionsDiv.innerHTML = '';
                              suggestionsDiv.classList.add('d-none');
                         }
                         this.updatePreview(); // Update preview after selecting suggestion
                    });
                });
            } else {
                suggestionsDiv.classList.add('d-none');
            }
        }
    }

    updateUI() {
        this.itemsTitle.textContent = this.state.isTrading ? 'Trading Items' : 'Items';
        // Adjust item controls visibility based on trading option
        this.itemControls.style.display = this.state.isTrading ? 'none' : 'flex';


        this.itemCount.textContent = `${this.state.activeItemCount} of ${this.state.isTrading ? 2 : 3}`; // Adjust item count display for trading

        this.itemsContainer.innerHTML = '';
        this.pricesContainer.innerHTML = '';

        const count = this.state.isTrading ? 2 : this.state.activeItemCount;
        for (let i = 0; i < count; i++) {
            this.itemsContainer.appendChild(this.createInputGroup('item', i));
            this.pricesContainer.appendChild(this.createInputGroup('price', i));
        }

        // Show/hide the respectively checkbox based on active item count and trading status
        this.respectivelyCheck.classList.toggle('d-none', this.state.activeItemCount <= 1 || this.state.isTrading);


        document.getElementById('addItem').disabled = this.state.activeItemCount >= 3 || this.state.isTrading;
        document.getElementById('removeItem').disabled = this.state.activeItemCount <= 1 || this.state.isTrading;

         // Hide the In Bulk option if trading is selected
        if (this.inBulkLabel) { // Check if the element exists
            this.inBulkLabel.style.display = this.state.isTrading ? 'none' : 'inline-flex';
             // If trading is selected, ensure inBulk state is false
             if (this.state.isTrading) {
                  this.state.useInBulk = false;
                  if (this.inBulkInput) {
                      this.inBulkInput.checked = false;
                       // Manually remove active class as the change listener might not fire if already false
                      this.inBulkLabel.classList.remove('active');
                  }
             }
        }


         // Hide the "Each" checkbox for prices if trading is selected
         // Need to re-select price inputs after updating the UI
          // Since elements are recreated, re-initializing state and active classes in createInputGroup is crucial
         document.querySelectorAll('.price-input-group .checkbox-button-label').forEach(label => {
             label.style.display = this.state.isTrading ? 'none' : 'inline-flex';
         });
         // If trading is selected, ensure useEach states are false
          if (this.state.isTrading) {
              this.state.useEach = [false, false, false];
              // No need to manually remove active classes here as updateUI recreates elements
          }

    }

    formatPrice(price) {
        if (!price) return '';

        let cleanPrice = price.toString().toLowerCase().replace(/[^0-9km.]/g, '');
        let numericValue;

        if (cleanPrice.includes('k')) {
            numericValue = parseFloat(cleanPrice.replace('k', '')) * 1000;
            if (!isNaN(numericValue)) {
                // Replace commas with periods in the formatted output
                return `$${numericValue.toLocaleString('en-US', { minimumFractionDigits: 0 }).replace(/,/g, '.')}`;
            }
        } else if (cleanPrice.includes('m')) {
            numericValue = parseFloat(cleanPrice.replace('m', '')) * 1000000;
            if (!isNaN(numericValue)) {
                return `$${(numericValue / 1000000).toFixed(0)} Million`; // No change for "Million"
            }
        } else {
            numericValue = parseFloat(cleanPrice);
            if (!isNaN(numericValue)) {
                // Replace commas with periods in the formatted output
                return `$${numericValue.toLocaleString('en-US', { minimumFractionDigits: 0 }).replace(/,/g, '.')}`;
            }
        }

        return ''; // Return empty string for invalid input
    }

    formatTransaction() {
        const { type, items, prices, useRespectively, activeItemCount, isTrading, useEach, usePluralS, useInBulk } = this.state;

        const validItems = items.slice(0, isTrading ? 2 : activeItemCount).filter(item => item.trim());
        if (validItems.length === 0) return '';

        if (isTrading) {
            if (validItems.length !== 2) return '';

            const [item1, quantity1] = validItems[0].split(' x ');
            const [item2, quantity2] = validItems[1].split(' x ');

            let formattedItem1 = item1.trim();
            let formattedItem2 = item2.trim();

            // Apply plural 's' only if no quantity is present AND 'Add S' is checked AND the item name doesn't already end in 's'
            if (!quantity1 && usePluralS[0] && !formattedItem1.endsWith('s')) {
                formattedItem1 += 's';
            }
             if (!quantity2 && usePluralS[1] && !formattedItem2.endsWith('s')) {
                formattedItem2 += 's';
            }


            const item1Text = quantity1 ? `${quantity1.trim()} ${formattedItem1}` : formattedItem1;
            const item2Text = quantity2 ? `${quantity2.trim()} ${formattedItem2}` : formattedItem2;

            let output = `Trading ${item1Text} for ${item2Text}`;

            // "In Bulk" option is not applicable for trading as per UI update logic,
            // but keeping the formatting logic here just in case requirements change.
            if (useInBulk) {
                output += ' in bulk';
            }

            const validPrices = prices.slice(0, 2).map(price => price.trim()).filter(price => price);
            if (validPrices.length > 0) {
                const priceText = validPrices.map((price, index) => {
                    const formattedPrice = this.formatPrice(price);
                     // "Each" option is not applicable for trading prices as per UI update logic.
                     // const suffix = useEach[index] ? ' each' : '';
                    return `${formattedPrice}`; // Removed suffix for trading prices
                }).join(' and '); // Always join with " and " for trading prices


                output += `. Price: ${priceText}`;
            } else {
                output += `. Price: Negotiable.`;
            }

            // Ensure the output ends with a full stop if it ends with an alphabetic character
            if (/[a-zA-Z]$/.test(output.trim())) { // Use trim() before checking last character
                 if (!output.trim().endsWith('.')) {
                     output += '.';
                 }
             } else if (output.trim() && !output.trim().endsWith('.')) {
                  // If output is not empty but doesn't end with a letter, add a dot if not present
                  output += '.';
             }


            return output.trim(); // Trim any leading/trailing whitespace
        }

        // Logic for Buying/Selling
        const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
        const formattedItems = validItems.map((item, index) => {
            const [itemName, quantity] = item.split(' x ');

            let modifiedItemName = itemName.trim();
             let formattedItem = quantity ? `${quantity.trim()} ${modifiedItemName}` : modifiedItemName; // Start with base item/quantity format

             // Apply plural 's' only if no quantity is present AND 'Add S' is checked AND the item name doesn't already end in 's'
             if (!quantity && usePluralS[index] && !modifiedItemName.endsWith('s')) {
                 formattedItem += 's';
             }


            if (validItems.length === 3) {
                if (index === 0) return formattedItem;
                if (index === 1) return `, ${formattedItem}`;
                return ` and ${formattedItem}`;
            } else if (validItems.length === 2) {
                if (index === 0) return formattedItem;
                return ` and ${formattedItem}`;
            }
            return formattedItem;
        }).join('');

        let output = `${capitalizedType} ${formattedItems}`;

        if (useInBulk) {
            output += ' in bulk';
        }

        const validPrices = prices
            .slice(0, activeItemCount)
            .map(price => price.trim())
            .filter(price => price);

        if (validPrices.length > 0) {
            const priceText = validPrices.map((price, index) => {
                const formattedPrice = this.formatPrice(price);
                const suffix = useEach[index] ? ' each' : '';

                if (validPrices.length === 3) {
                    if (index === 0) return formattedPrice + suffix;
                    if (index === 1) return `, ${formattedPrice}${suffix}`;
                    return ` and ${formattedPrice}${suffix}`;
                } else if (validPrices.length === 2) {
                    if (index === 0) return formattedPrice + suffix;
                    return ` and ${formattedPrice}${suffix}`;
                }
                return formattedPrice + suffix;
            }).join('');

            if (validPrices.length === 1) {
                output += `. ${type === 'buying' ? 'Budget' : 'Price'}: ${priceText}`;
            } else if (useRespectively && validPrices.length === validItems.length) {
                output += `. ${type === 'buying' ? 'Budget' : 'Price'}: ${priceText} respectively`;
            } else {
                output += `. ${type === 'buying' ? 'Budget' : 'Price'}: ${priceText}`;
            }
        } else {
            output += `. ${type === 'buying' ? 'Budget' : 'Price'}: Negotiable.`;
        }

        // Ensure the output ends with a full stop if it ends with an alphabetic character
         if (/[a-zA-Z]$/.test(output.trim())) {
             if (!output.trim().endsWith('.')) {
                 output += '.';
             }
         } else if (output.trim() && !output.trim().endsWith('.')) {
             output += '.';
         }


        return output.trim();
    }


    updatePreview() {
        const output = this.formatTransaction();
        this.preview.textContent = output || 'Complete the form to generate your transaction description';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new TransactionForm();

    // Hide suggestions when clicking outside of any input-group
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.input-group')) {
            document.querySelectorAll('.suggestions').forEach(s => {
                s.classList.add('d-none');
            });
        }
    });
});